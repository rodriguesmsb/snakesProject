---
title: "Acidentes_ofidicos"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
#Load specific function created for this 
source("S2A_useFunc.R")
```


```{r}
#read data
dados <- read_csv("data/2019_06_25_Snakebite.csv")
```


```{r}
#Genral characteristics of accidents
desc_vars <- c("CS_SEXO", "ANT_ZONA", "EVOLUCAO", "ANT_LOCA_1", "ANI_SERPEN", "ANT_TEMPO_", "TRA_CLASSI")
for(desc_var in desc_vars){
    print(knitr::kable(compute_prop(dados, !! rlang::sym(desc_var))))
}


compute_desc(dados, AGE, CITY, "median") %>% spread(key = "CITY", value = "Median")
for(desc_var in desc_vars){
 print("Proportion values")
 print(knitr::kable(compute_desc(dados, !! rlang::sym(desc_var), CITY) %>% 
    select(-numb) %>% 
    spread(key = "CITY", value = "Proportion")))
 
  print("N values")
  print(knitr::kable(compute_desc(dados, !! rlang::sym(desc_var), CITY) %>% 
    select(-Proportion) %>% 
    spread(key = "CITY", value = "numb")))
}



```


```{r}
#Spliting data for each city
pvh <-  split_city(data = dados, city = "Porto Velho")
cacoal <- split_city(data = dados, city = "Cacoal")
ariquemes <- split_city(data = dados, city = "Ariquemes")
vilhena <- split_city(data = dados, city = "Vilhena")
```


```{r}
#read climate datasets
max_temp <- make_df(path = "data/2019_06_24_LSTD.csv") %>% rename(max_temp = var_sum)
min_temp <- make_df(path = "data/2019_06_24_LSTN.csv")  %>% rename(min_temp = var_sum)
rainfall <- make_df(path = "data/2019_06_24_Rainfall.csv")  %>% rename(rain = var_sum)
humidity <- make_df(path = "data/2019_06_24_Humidity.csv") %>% rename(hum = var_sum)
humidity <- humidity %>% 
   mutate(hum = hum * 1000)

#Join all datasets
clima <- list(max_temp, min_temp, rainfall, humidity)
clima_df <- clima %>% reduce(left_join, by = c("ym", "city"))
clima_df <- clima_df %>% 
      mutate(amplitude = max_temp - min_temp)


climate_vars <- c("rain", "hum", "max_temp", "min_temp")

for(clima_var in climate_vars){
  print(clima_var)
  print(knitr::kable(clima_df %>% 
  group_by(city) %>% 
  summarise(IQ = quantile(!! rlang::sym(clima_var), probs = c(0.25), na.rm = TRUE),
            mean = mean(!! rlang::sym(clima_var), na.rm = TRUE),
            median = median(!! rlang::sym(clima_var), na.rm = TRUE),
            IIQ = quantile(!! rlang::sym(clima_var), probs = c(0.75), na.rm = TRUE),
            sd = sd(!! rlang::sym(clima_var), na.rm = TRUE))))
  
}
```


```{r}
#read population data
df_pop <-  read_csv("data/2019_pop.csv")
df_pop <- df_pop %>% 
  filter(cod_ibg %in% list(110020, 110004, 110002, 110030))
df_pop <- df_pop %>% 
  mutate(city = as.character(factor(cod_ibg, levels = c(110020, 110002, 110004, 110030),
                                    labels = c("Porto Velho", "Ariquemes", "Cacoal", "Vilhena"))))

clima_df <- clima_df %>% 
  mutate(ano = as.numeric(substr(ym, start = 1, stop = 4)))

clima_df <- left_join(clima_df,df_pop)


#Remove data from memory
rm(list = c("clima", "min_temp", "max_temp", "rainfall", "df_pop"))
```


```{r}
#Plot incidence by year
pvh <- left_join(pvh, clima_df, by = c("ym", "city"))
cacoal <- left_join(cacoal, clima_df, by = c("ym", "city"))
ariquemes <- left_join(ariquemes, clima_df, by = c("ym", "city"))
vilhena <- left_join(vilhena, clima_df, by = c("ym", "city"))
```


```{r}
#Descriptive analysis
desc_df <-  rbind(pvh, cacoal, ariquemes, vilhena)
desc_df <- desc_df %>%
  mutate(incidence = total/pop * 100000) %>%
  rename(time = data)

#compute overall incidence among cities
desc_df %>% 
  filter(city == "Vilhena") %>% 
  group_by(ano) %>% 
  summarise(cases = sum(total),
            av = sum(incidence)) %>% 
  mutate(N = sum(cases))
    

desc_df %>%
  mutate(city = factor(city, levels = c("Porto Velho", "Ariquemes", "Cacoal", "Vilhena"))) %>% 
  ggplot(aes(x = time, y = incidence)) +
          geom_line() +
          theme_bw(base_size = 28) +
          labs(x = NULL, y = "Snakebite incidence per 100,000 inhab.") +
          facet_wrap(~city) +
          ggsave("results/Fig_1.tiff", device = "tiff", width = 18, height = 12)


cities <- c("Cacoal", "Ariquemes", "Porto Velho", "Vilhena")

for(c in cities){
  print(paste("Yearly Descriptive analsys for", c))
  print(desc_df  %>% 
    filter(city == c) %>% 
    group_by(ano, pop) %>% 
    summarise(cases = sum(total)) %>%
    mutate(incidence = cases/pop * 100000) %>% 
    arrange(desc(incidence)))
}



#Compute overall monthly incidence
desc_df %>% 
  group_by(city) %>% 
  summarise(av = mean(incidence),
            LB = mean(incidence) - (1.96 * sd(incidence)/sqrt(144)),
            UB = mean(incidence) + (1.96 * sd(incidence)/sqrt(144)))

for(c in cities){
  print(desc_df %>% 
    filter(city == c) %>% 
    mutate(month = month(time)) %>% 
    group_by(month) %>% 
    summarise(average = mean(incidence),
              sd = sd(incidence)) %>% 
    arrange(desc(average))) 
}
```


```{r}

#Time series plot
clima_df <- clima_df %>% 
  mutate(time = ymd(paste0(ym, "-01")))

plot_seas_ts(clima_df, rain, expression(paste("Average rainfall in ", mm^3))) +
  ggsave("results/Supp_rain.tiff", device = "tiff", width = 18, height = 12)

plot_seas_ts(clima_df, max_temp, expression(paste("Average maximum temperature", ~degree, "C"))) +
  ggsave("results/Supp_maxTemp.tiff", device = "tiff", width = 18, height = 12)

plot_seas_ts(clima_df, min_temp, expression(paste("Average minimum temperature", ~degree, "C"))) +
  ggsave("results/Supp_minTemp.tiff", device = "tiff", width = 18, height = 12)

plot_seas_ts(clima_df, hum, expression(paste("Average humidity ", "kg/kg"))) +
  ggsave("results/Supp_hum.tiff", device = "tiff", width = 18, height = 12)

plot_seas_ts(desc_df, incidence, "Seasonality of snakebite incidence per 100,000 inh") +
  ggsave("results/Figure_1.tiff", device = "tiff", width = 18, height = 12)
```


```{r}
#Run models
graph_ariquemes <- run_inla(ariquemes, clima_df, TRUE)
graph_cacoal <- run_inla(cacoal, clima_df, TRUE)
graph_pvh <-  run_inla(pvh, clima_df, TRUE)
graph_vilhena <-  run_inla(vilhena, clima_df, TRUE)
```


```{r}

graph_ariquemes[[2]]
```


```{r}
ggarrange(graph_pvh[[1]],
          graph_ariquemes[[1]],
          graph_cacoal[[1]], 
          graph_vilhena[[1]],
          labels = c("(A)", "(B)", "(C)", "(D)"),
          font.label = list(size = 20)) +
  ggsave("results/Figure_2.tiff", device = "tiff", width = 18, height = 12)
```

